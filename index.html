<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQ Battle: Max Compatibility</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6c5ce7;
            --accent: #00b894;
            --danger: #ff7675;
            --text-main: #2d3436;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #app {
            background: var(--glass-bg);
            width: 95%;
            max-width: 500px;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
        }

        h1 { font-weight: 900; color: var(--primary); margin-top: 0; }
        
        .btn {
            background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px;
            font-size: 1rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px;
            transition: 0.2s;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn:active { transform: scale(0.98); }
        
        .input-box {
            padding: 12px; border-radius: 8px; border: 2px solid #ddd; width: 100%;
            font-size: 1.1rem; text-align: center; margin-bottom: 10px; font-family: 'Outfit', sans-serif;
        }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Grid & Cards */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .card-btn {
            background: white; border: 2px solid #eee; padding: 15px; border-radius: 12px;
            cursor: pointer; font-weight: 600; min-height: 60px; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .card-btn:hover { border-color: var(--primary); background: #f8f9fa; }
        
        /* Status Bar */
        #statusBox {
            margin-top: 15px; padding: 10px; border-radius: 8px; background: #f1f2f6;
            font-size: 0.85rem; font-weight: 600; color: #666;
        }
        
        /* Game UI */
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; background: #eee; padding: 10px; border-radius: 10px; }
        .correct { background: var(--accent) !important; color: white; border-color: var(--accent); }
        .wrong { background: var(--danger) !important; color: white; border-color: var(--danger); }
        
        /* Slider */
        input[type=range] { width: 100%; accent-color: var(--primary); margin: 20px 0; }
        .diff-val { font-size: 3rem; font-weight: 900; color: var(--primary); }
    </style>
</head>
<body>

<div id="app">
    <!-- 1. LOBBY -->
    <div id="screen-lobby" class="screen active">
        <h1>IQ BATTLE</h1>
        <p style="font-size:0.9rem; color:#666;">Max Compatibility Mode</p>
        
        <div style="background:white; padding:20px; border-radius:15px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.05);">
            <h3>HOST</h3>
            <button class="btn" id="btnHost" onclick="lobby.hostGame()">Create Room</button>
            <div id="hostArea" style="display:none; margin-top:15px;">
                <p>Your Room ID:</p>
                <input type="text" id="myId" class="input-box" readonly onclick="this.select()">
                <div class="loader"></div>
            </div>
        </div>

        <div style="background:white; padding:20px; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.05);">
            <h3>JOIN</h3>
            <input type="text" id="joinId" class="input-box" placeholder="Paste ID Here">
            <button class="btn" id="btnJoin" style="background:#2d3436;" onclick="lobby.joinGame()">Join Room</button>
        </div>

        <div id="statusBox">Status: Ready</div>
    </div>

    <!-- 2. GAME UI -->
    <div id="screen-game" class="screen">
        <div class="header">
            <div>You: <span id="scoreMe">0</span></div>
            <div>Opponent: <span id="scoreOp">0</span></div>
        </div>
        
        <!-- Phases -->
        <div id="phase-theme">
            <h2>Select Theme</h2>
            <div id="themeGrid" class="grid-container"></div>
            <p id="themeMsg" style="margin-top:20px; color:#888;"></p>
        </div>

        <div id="phase-diff" style="display:none;">
            <div style="background:var(--primary); color:white; padding:4px 12px; border-radius:20px; display:inline-block; font-size:0.8rem;">THEME</div>
            <h2 id="themeLabel"></h2>
            <p id="diffMsg">Rate your knowledge (1-10)</p>
            <div id="diffControls">
                <div class="diff-val"><span id="sliderVal">5</span></div>
                <input type="range" min="1" max="10" value="5" oninput="document.getElementById('sliderVal').innerText=this.value" id="diffSlider">
                <button class="btn" onclick="game.lockDifficulty()">CONFIRM</button>
            </div>
        </div>

        <div id="phase-qa" style="display:none;">
            <div style="color:var(--primary); font-weight:800; text-transform:uppercase; font-size:0.8rem;">For <span id="pts">0</span> Points</div>
            <h3 id="qText">Loading...</h3>
            <div id="ansGrid" class="grid-container"></div>
            <div id="feedback" style="margin-top:15px; font-weight:800; min-height:20px;"></div>
            <button id="nextBtn" class="btn" style="display:none;" onclick="game.nextRound()">NEXT ROUND</button>
            <p id="qaMsg" style="color:#888; display:none;"></p>
        </div>
    </div>

    <div id="screen-win" class="screen">
        <h1 id="winTitle">GAME OVER</h1>
        <h2 id="finalScore"></h2>
        <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    // Massive list of STUN servers to bypass firewalls
    const PEER_CONFIG = {
        debug: 1,
        config: {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                { urls: 'stun:stun.nextcloud.com:443' } // Port 443 helps bypass corporate firewalls
            ]
        }
    };

    const CATEGORIES = [
        {id:9,n:"General"}, {id:11,n:"Movies"}, {id:12,n:"Music"}, {id:15,n:"Games"},
        {id:17,n:"Science"}, {id:21,n:"Sports"}, {id:22,n:"Geography"}, {id:23,n:"History"},
        {id:27,n:"Animals"}, {id:31,n:"Anime"}
    ];

    // --- LOGGING ---
    function log(msg, err=false) {
        console.log(msg);
        const b = document.getElementById('statusBox');
        b.innerText = msg;
        b.style.color = err ? "red" : "#666";
        b.style.background = err ? "#ffeaea" : "#f1f2f6";
    }

    // --- NETWORK ---
    let peer, conn, isHost = false;

    const lobby = {
        hostGame: () => {
            isHost = true;
            document.getElementById('btnHost').disabled = true;
            log("Initializing Network...");
            
            peer = new Peer(null, PEER_CONFIG);
            
            peer.on('open', (id) => {
                document.getElementById('hostArea').style.display = 'block';
                document.getElementById('myId').value = id;
                log("Room Open. Waiting for player...");
            });

            peer.on('connection', (c) => {
                conn = c;
                log("Player Connecting...");
                lobby.bindEvents();
            });
            
            peer.on('error', e => log("Host Error: " + e.type, true));
        },

        joinGame: () => {
            isHost = false;
            const id = document.getElementById('joinId').value.trim();
            if(!id) return log("Enter ID first", true);
            
            document.getElementById('btnJoin').disabled = true;
            log("Connecting to Room...");
            
            peer = new Peer(null, PEER_CONFIG);
            
            peer.on('open', () => {
                log("Locating Host...");
                conn = peer.connect(id, { reliable: true });
                
                // Fallback timeout
                setTimeout(() => {
                    if(!conn.open) log("Connection Stuck. Try Mobile Hotspot.", true);
                }, 8000);

                lobby.bindEvents();
            });
            
            peer.on('error', e => log("Join Error: " + e.type + ". Check ID.", true));
        },

        bindEvents: () => {
            conn.on('open', () => {
                log("Connected! Starting...");
                setTimeout(() => { if(isHost) game.init(); }, 1000);
            });
            conn.on('data', data => handleData(data));
            conn.on('close', () => alert("Disconnected"));
            conn.on('error', e => log("Net Error: " + e, true));
        },

        send: (type, payload) => {
            if(conn && conn.open) conn.send({t:type, p:payload});
        }
    };

    // --- GAME LOGIC ---
    const state = {
        turn: 'host', scores: {h:0, c:0}, themes: [], theme: null, bet: 5, q: null
    };

    function handleData(msg) {
        switch(msg.t) {
            case 'START': state.turn = msg.p.turn; ui.showGame(); break;
            case 'ROUND': state.themes = msg.p.themes; state.turn = msg.p.turn; ui.round(); break;
            case 'THEME': state.theme = msg.p.theme; ui.diff(); break;
            case 'Q': state.q = msg.p.q; state.bet = msg.p.bet; ui.qa(); break;
            case 'SCORE': 
                state.scores = msg.p.scores; 
                state.turn = msg.p.turn; 
                ui.updateScores(); 
                ui.feedback(msg.p.res, msg.p.ans); 
                break;
            case 'WIN': state.scores = msg.p.scores; ui.win(msg.p.winner); break;
        }
    }

    const game = {
        init: () => {
            state.turn = Math.random()>0.5 ? 'host' : 'client';
            lobby.send('START', {turn: state.turn});
            ui.showGame();
            game.newRound();
        },
        newRound: () => {
            if(!isHost) return;
            const t = [...CATEGORIES].sort(()=>0.5-Math.random()).slice(0,4);
            state.themes = t;
            lobby.send('ROUND', {themes:t, turn:state.turn});
            ui.round();
        },
        pickTheme: (t) => {
            if(!game.isMyTurn()) return;
            state.theme = t;
            lobby.send('THEME', {theme:t});
            ui.diff();
        },
        lockDifficulty: () => {
            const val = parseInt(document.getElementById('diffSlider').value);
            state.bet = val;
            document.getElementById('diffControls').style.display = 'none';
            document.getElementById('diffMsg').innerText = "Fetching Question...";
            game.fetchQ(state.theme.id, val);
        },
        fetchQ: async (cat, diff) => {
            let d = diff<=3?'easy':(diff>=8?'hard':'medium');
            try {
                const r = await fetch(`https://opentdb.com/api.php?amount=1&category=${cat}&difficulty=${d}&type=multiple`);
                const j = await r.json();
                if(j.results && j.results.length) {
                    state.q = j.results[0];
                    lobby.send('Q', {q:state.q, bet:state.bet});
                    ui.qa();
                } else game.fetchQ(cat, diff);
            } catch(e) { alert("API Error"); }
        },
        answer: (ans) => {
            const correct = state.q.correct_answer === ans;
            const pts = correct ? state.bet : 0;
            if(state.turn === 'host') state.scores.h += pts; else state.scores.c += pts;
            
            let winner = null;
            if(state.scores.h >= 25) winner = 'host';
            if(state.scores.c >= 25) winner = 'client';

            if(winner) {
                lobby.send('WIN', {scores:state.scores, winner});
                ui.win(winner);
            } else {
                const next = state.turn==='host'?'client':'host';
                const payload = {scores:state.scores, res:correct, ans:state.q.correct_answer, turn:next};
                lobby.send('SCORE', payload);
                state.scores = payload.scores; state.turn = next;
                ui.updateScores(); ui.feedback(correct, state.q.correct_answer);
            }
        },
        isMyTurn: () => (isHost && state.turn==='host') || (!isHost && state.turn==='client')
    };

    // --- UI ---
    function decode(html) { const t=document.createElement("textarea"); t.innerHTML=html; return t.value; }

    const ui = {
        showGame: () => {
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            ui.updateScores();
        },
        updateScores: () => {
            document.getElementById('scoreMe').innerText = isHost ? state.scores.h : state.scores.c;
            document.getElementById('scoreOp').innerText = isHost ? state.scores.c : state.scores.h;
        },
        round: () => {
            hideAll(); document.getElementById('phase-theme').style.display='block';
            const g = document.getElementById('themeGrid'); g.innerHTML = '';
            const myTurn = game.isMyTurn();
            document.getElementById('themeMsg').innerText = myTurn ? "Choose a Topic" : "Opponent choosing...";
            
            if(myTurn) {
                state.themes.forEach(t => {
                    const b = document.createElement('div'); b.className = 'card-btn'; b.innerText = t.n;
                    b.onclick = () => game.pickTheme(t);
                    g.appendChild(b);
                });
            }
        },
        diff: () => {
            hideAll(); document.getElementById('phase-diff').style.display='block';
            document.getElementById('themeLabel').innerText = state.theme.n;
            const myTurn = game.isMyTurn();
            document.getElementById('diffControls').style.display = myTurn ? 'block' : 'none';
            document.getElementById('diffMsg').innerText = myTurn ? "Rate your knowledge (1-10)" : "Opponent is betting...";
            document.getElementById('diffSlider').value = 5; 
            document.getElementById('sliderVal').innerText = 5;
        },
        qa: () => {
            hideAll(); document.getElementById('phase-qa').style.display='block';
            document.getElementById('pts').innerText = state.bet;
            document.getElementById('qText').innerHTML = state.q.question;
            document.getElementById('feedback').innerText = "";
            document.getElementById('nextBtn').style.display = "none";
            const g = document.getElementById('ansGrid'); g.innerHTML = '';
            
            const myTurn = game.isMyTurn();
            document.getElementById('qaMsg').style.display = myTurn ? 'none' : 'block';
            document.getElementById('qaMsg').innerText = "Opponent answering...";

            const ans = [...state.q.incorrect_answers, state.q.correct_answer].sort(()=>0.5-Math.random());
            ans.forEach(a => {
                const b = document.createElement('button'); b.className = 'card-btn'; b.style.width="100%"; b.innerHTML = a;
                if(myTurn) b.onclick = () => game.answer(a);
                else b.disabled = true;
                g.appendChild(b);
            });
        },
        feedback: (correct, txt) => {
            const btns = document.querySelectorAll('#ansGrid button');
            btns.forEach(b => {
                if(b.innerHTML === txt) b.classList.add('correct');
                else b.classList.add('disabled');
            });
            const f = document.getElementById('feedback');
            f.innerText = correct ? "CORRECT!" : "WRONG!";
            f.style.color = correct ? "var(--accent)" : "var(--danger)";
            
            if(isHost) document.getElementById('nextBtn').style.display = "block";
            else document.getElementById('qaMsg').innerText = "Waiting for host...";
        },
        win: (w) => {
            document.getElementById('screen-game').classList.remove('active');
            document.getElementById('screen-win').classList.add('active');
            const iWon = (isHost && w==='host') || (!isHost && w==='client');
            document.getElementById('winTitle').innerText = iWon ? "VICTORY!" : "DEFEAT";
            document.getElementById('finalScore').innerText = `${state.scores.h} - ${state.scores.c}`;
        }
    };
    function hideAll(){
        ['phase-theme','phase-diff','phase-qa'].forEach(id=>document.getElementById(id).style.display='none');
    }
</script>
</body>
</html>