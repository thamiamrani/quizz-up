<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQ Battle: Firebase Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6c5ce7;
            --accent: #00b894;
            --danger: #ff7675;
            --text-main: #2d3436;
            --bg-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --glass-bg: rgba(255, 255, 255, 0.9);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #app {
            background: var(--glass-bg);
            width: 95%;
            max-width: 500px;
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
        }

        h1 { font-weight: 900; color: var(--primary); margin-top: 0; }
        
        .btn {
            background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px;
            font-size: 1rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px;
            transition: 0.2s; box-shadow: 0 4px 0 #4834d4;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:disabled { background: #b2bec3; box-shadow: none; cursor: default; }
        
        .input-box {
            padding: 12px; border-radius: 8px; border: 2px solid #dfe6e9; width: 100%;
            font-size: 1.1rem; text-align: center; margin-bottom: 10px; font-family: 'Outfit', sans-serif;
            font-weight: 700; color: var(--text-main);
        }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Game UI */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .card-btn {
            background: white; border: 2px solid #eee; padding: 15px; border-radius: 12px;
            cursor: pointer; font-weight: 600; min-height: 60px; display: flex; align-items: center; justify-content: center;
            transition: 0.1s;
        }
        .card-btn:hover { border-color: var(--primary); background: #fdfdfd; }
        .correct { background: var(--accent) !important; color: white !important; border-color: var(--accent) !important; }
        .wrong { background: var(--danger) !important; color: white !important; border-color: var(--danger) !important; }
        .disabled { pointer-events: none; opacity: 0.6; }

        .header { display: flex; justify-content: space-between; margin-bottom: 20px; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 12px; }
        input[type=range] { width: 100%; accent-color: var(--primary); margin: 20px 0; }
        .diff-val { font-size: 3rem; font-weight: 900; color: var(--primary); }
        
        .status-pill { background: #ffeaa7; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; display: inline-block; margin-top: 10px; font-weight: 700; color: #d35400; }
    </style>
</head>
<body>

<div id="app">
    <!-- 1. SETUP SCREEN (If Config Missing) -->
    <div id="screen-setup" class="screen">
        <h1>SETUP REQUIRED</h1>
        <p>You need to add your Firebase Config to the HTML file code.</p>
        <p style="font-size:0.8rem">Open index.html and look for "PASTE YOUR CONFIG HERE"</p>
    </div>

    <!-- 2. LOBBY -->
    <div id="screen-lobby" class="screen active">
        <h1>IQ BATTLE</h1>
        <p style="color:#636e72;">Server-Based Multiplayer</p>
        
        <div style="background:white; padding:20px; border-radius:16px; margin-bottom:15px;">
            <h3>HOST GAME</h3>
            <button class="btn" id="btnHost" onclick="lobby.createGame()">Create Room</button>
            <div id="hostArea" style="display:none; margin-top:15px;">
                <p style="margin-bottom:5px;">Room ID:</p>
                <input type="text" id="roomIdDisplay" class="input-box" readonly onclick="this.select()">
                <div class="status-pill">Waiting for player...</div>
            </div>
        </div>

        <div style="background:white; padding:20px; border-radius:16px;">
            <h3>JOIN GAME</h3>
            <input type="text" id="joinInput" class="input-box" placeholder="Enter Room ID">
            <button class="btn" onclick="lobby.joinGame()">Join Room</button>
        </div>
    </div>

    <!-- 3. GAMEPLAY -->
    <div id="screen-game" class="screen">
        <div class="header">
            <div><strong>You:</strong> <span id="myScore">0</span></div>
            <div><strong>Enemy:</strong> <span id="opScore">0</span></div>
        </div>

        <!-- Dynamic Content Area -->
        <div id="gameContent"></div>

        <div id="msgArea" style="margin-top:20px; font-weight:bold; color:#636e72;"></div>
    </div>

    <!-- 4. WIN SCREEN -->
    <div id="screen-win" class="screen">
        <div style="font-size:4rem">üèÜ</div>
        <h1 id="winTitle">GAME OVER</h1>
        <h2 id="finalScore"></h2>
        <button class="btn" onclick="location.reload()">MAIN MENU</button>
    </div>
</div>

<!-- FIREBASE SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ==========================================
    // üî¥ PASTE YOUR CONFIG HERE üî¥
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyArnXgw9HLpylJwW-zvvKQvsAqStogb3fc",
        authDomain: "beturbrain.firebaseapp.com",
        databaseURL: "https://beturbrain-default-rtdb.firebaseio.com",
        projectId: "beturbrain",
        storageBucket: "beturbrain.firebasestorage.app",
        messagingSenderId: "1060550184148",
        appId: "1:1060550184148:web:2153902d179accaf8d7f41"
    };
    // ==========================================

    // Init Firebase
    let app, db;
    try {
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
    } catch(e) {
        document.getElementById('screen-lobby').classList.remove('active');
        document.getElementById('screen-setup').classList.add('active');
    }

    // --- GAME CONSTANTS ---
    const CATEGORIES = [
        {id:9,n:"General"}, {id:11,n:"Movies"}, {id:12,n:"Music"}, {id:15,n:"Games"},
        {id:17,n:"Science"}, {id:21,n:"Sports"}, {id:22,n:"Geography"}, {id:23,n:"History"},
        {id:27,n:"Animals"}, {id:31,n:"Anime"}
    ];

    let myRole = null; // 'host' or 'guest'
    let roomRef = null;
    let currentGameState = {};

    // --- LOBBY LOGIC ---
    window.lobby = {
        createGame: async () => {
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            myRole = 'host';
            roomRef = ref(db, 'games/' + roomId);

            // Initial State
            await set(roomRef, {
                status: 'waiting',
                turn: Math.random() > 0.5 ? 'host' : 'guest',
                scores: { host: 0, guest: 0 },
                round: 0,
                themes: [],
                currentTheme: null,
                bet: 5,
                question: null,
                feedback: null
            });

            document.getElementById('hostArea').style.display = 'block';
            document.getElementById('roomIdDisplay').value = roomId;
            document.getElementById('btnHost').disabled = true;

            // Subscribe
            onValue(roomRef, (snapshot) => handleUpdate(snapshot.val()));
        },

        joinGame: async () => {
            const roomId = document.getElementById('joinInput').value.trim().toUpperCase();
            if (!roomId) return alert("Enter ID");
            
            myRole = 'guest';
            roomRef = ref(db, 'games/' + roomId);

            const snap = await get(roomRef);
            if (!snap.exists()) return alert("Room not found");

            // Update status to start
            update(roomRef, { status: 'playing' });
            
            // Generate first round if it hasn't started
            if (snap.val().status === 'waiting') {
                // Trigger host to generate (handled via state change usually, but we force sync here)
            }

            // Subscribe
            onValue(roomRef, (snapshot) => handleUpdate(snapshot.val()));
        }
    };

    // --- MAIN GAME LOOP (State Sync) ---
    function handleUpdate(data) {
        if (!data) return; // Room deleted
        currentGameState = data;

        // 1. Check for Lobby -> Game transition
        if (data.status === 'playing' && document.getElementById('screen-lobby').classList.contains('active')) {
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            if(myRole === 'host') game.startNewRound();
        }

        // 2. Update Scores
        const p1Score = myRole === 'host' ? data.scores.host : data.scores.guest;
        const p2Score = myRole === 'host' ? data.scores.guest : data.scores.host;
        document.getElementById('myScore').innerText = p1Score;
        document.getElementById('opScore').innerText = p2Score;

        // 3. Render Phase
        renderPhase(data);
    }

    function renderPhase(data) {
        const content = document.getElementById('gameContent');
        const msg = document.getElementById('msgArea');
        const isMyTurn = data.turn === myRole;

        // WIN CHECK
        if(data.status === 'finished') {
             document.getElementById('screen-game').classList.remove('active');
             document.getElementById('screen-win').classList.add('active');
             const iWon = data.winner === myRole;
             document.getElementById('winTitle').innerText = iWon ? "VICTORY" : "DEFEAT";
             document.getElementById('finalScore').innerText = `${data.scores.host} - ${data.scores.guest}`;
             return;
        }

        // PHASE: THEME SELECTION
        if (data.phase === 'theme') {
            msg.innerText = isMyTurn ? "Pick a Topic" : "Opponent is choosing...";
            if (isMyTurn) {
                let html = `<div class="grid-container">`;
                data.themes.forEach((t, i) => {
                    html += `<button class="card-btn" onclick="game.selectTheme(${i})">${t.n}</button>`;
                });
                html += `</div>`;
                content.innerHTML = `<h2>Select Theme</h2>${html}`;
            } else {
                content.innerHTML = `<h2>Waiting...</h2><div class="loader">Opponent choosing theme</div>`;
            }
        }

        // PHASE: BETTING (DIFFICULTY)
        if (data.phase === 'bet') {
            msg.innerText = isMyTurn ? "Rate your knowledge" : "Opponent is betting...";
            if (isMyTurn) {
                content.innerHTML = `
                    <div style="background:#6c5ce7; color:white; padding:5px 15px; border-radius:20px; display:inline-block;">${data.currentTheme.n}</div>
                    <h2>How confident are you?</h2>
                    <div class="diff-val"><span id="sliderVal">5</span></div>
                    <input type="range" min="1" max="10" value="5" oninput="document.getElementById('sliderVal').innerText=this.value" id="diffSlider">
                    <button class="btn" onclick="game.submitBet()">Confirm</button>
                `;
            } else {
                 content.innerHTML = `<h2>${data.currentTheme.n}</h2><p>Opponent is betting...</p>`;
            }
        }

        // PHASE: QUESTION
        if (data.phase === 'question') {
            msg.innerText = isMyTurn ? "Answer the question" : "Opponent is thinking...";
            
            let ansHtml = '<div class="grid-container">';
            // We need to render answers. If already answered (feedback exists), show colors
            data.question.answers.forEach(ans => {
                let extraClass = '';
                if(data.feedback) {
                    if(ans === data.question.correct) extraClass = 'correct';
                    else extraClass = 'disabled';
                }
                
                // If I am active player, click works. If not, disabled.
                let clickAction = isMyTurn && !data.feedback ? `onclick="game.submitAnswer('${ans.replace(/'/g, "\\'")}')"` : '';
                if (!isMyTurn) extraClass += ' disabled';

                ansHtml += `<button class="card-btn ${extraClass}" ${clickAction}>${ans}</button>`;
            });
            ansHtml += '</div>';

            let feedbackHtml = data.feedback ? `<div style="margin-top:20px; font-weight:900; font-size:1.2rem; color:${data.feedback.correct ? '#00b894' : '#ff7675'}">${data.feedback.text}</div>` : '';
            
            let nextBtn = (myRole === 'host' && data.feedback) ? `<button class="btn" onclick="game.startNewRound()">Next Round</button>` : '';
            if(myRole !== 'host' && data.feedback) nextBtn = `<p style="margin-top:20px">Waiting for Host...</p>`;

            content.innerHTML = `
                <div style="font-weight:900; color:#6c5ce7;">FOR ${data.bet} POINTS</div>
                <h3 style="margin:10px 0 20px 0">${data.question.q}</h3>
                ${ansHtml}
                ${feedbackHtml}
                ${nextBtn}
            `;
        }
    }

    // --- GAME ACTIONS ---
    window.game = {
        startNewRound: () => {
            // Only Host Generates Data
            const themes = [...CATEGORIES].sort(()=>0.5-Math.random()).slice(0,4);
            update(roomRef, {
                phase: 'theme',
                themes: themes,
                feedback: null
            });
        },

        selectTheme: (index) => {
            const theme = currentGameState.themes[index];
            update(roomRef, {
                phase: 'bet',
                currentTheme: theme
            });
        },

        submitBet: async () => {
            const val = parseInt(document.getElementById('diffSlider').value);
            // Fetch Question
            let apiDiff = val<=3?'easy':(val>=8?'hard':'medium');
            document.getElementById('gameContent').innerHTML = "Loading Question...";
            
            try {
                const res = await fetch(`https://opentdb.com/api.php?amount=1&category=${currentGameState.currentTheme.id}&difficulty=${apiDiff}&type=multiple`);
                const json = await res.json();
                const qData = json.results[0];
                const allAns = [...qData.incorrect_answers, qData.correct_answer].sort(()=>0.5-Math.random());

                update(roomRef, {
                    phase: 'question',
                    bet: val,
                    question: {
                        q: qData.question,
                        correct: qData.correct_answer,
                        answers: allAns
                    }
                });
            } catch(e) { alert("Error fetching question"); }
        },

        submitAnswer: (ans) => {
            const isCorrect = ans === currentGameState.question.correct;
            const points = isCorrect ? currentGameState.bet : 0;
            
            // Calculate new scores
            const newScores = { ...currentGameState.scores };
            if (currentGameState.turn === 'host') newScores.host += points;
            else newScores.guest += points;

            // Check Win
            let status = 'playing';
            let winner = null;
            if(newScores.host >= 25) { status = 'finished'; winner = 'host'; }
            else if(newScores.guest >= 25) { status = 'finished'; winner = 'guest'; }

            // Next Turn
            const nextTurn = currentGameState.turn === 'host' ? 'guest' : 'host';

            update(roomRef, {
                scores: newScores,
                status: status,
                winner: winner,
                turn: nextTurn, // Swap turn for next round
                feedback: {
                    correct: isCorrect,
                    text: isCorrect ? "CORRECT!" : "WRONG!"
                }
            });
        }
    };
</script>
</body>
</html>